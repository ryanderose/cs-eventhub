{"version":3,"sources":["../src/index.ts","../src/theme.ts"],"sourcesContent":["import type { PageDoc } from '@events-hub/page-schema';\nimport { encodePlan } from '@events-hub/router-helpers';\nimport { baseTokens, createShadowThemeCss, type TokenMap } from './theme';\n\nexport type EmbedConfig = {\n  container: HTMLElement;\n  tenantId: string;\n  initialPlan?: PageDoc;\n  theme?: Record<string, string>;\n};\n\nexport type HydrateOptions = {\n  plan: PageDoc;\n  pushState?: boolean;\n};\n\nexport type SdkEventMap = {\n  ready: { tenantId: string };\n  'plan:hydrate': { plan: PageDoc };\n  'plan:error': { error: Error };\n  'analytics:event': { name: string; payload: Record<string, unknown> };\n};\n\nexport type EmbedHandle = {\n  hydrateNext(options: HydrateOptions): void;\n  destroy(): void;\n  on<Event extends keyof SdkEventMap>(event: Event, listener: (payload: SdkEventMap[Event]) => void): void;\n  off<Event extends keyof SdkEventMap>(event: Event, listener: (payload: SdkEventMap[Event]) => void): void;\n  getShadowRoot(): ShadowRoot;\n};\n\ntype Listener<Event extends keyof SdkEventMap> = (payload: SdkEventMap[Event]) => void;\n\nclass EventEmitter {\n  private listeners = new Map<keyof SdkEventMap, Set<Listener<keyof SdkEventMap>>>();\n\n  private ensureListenerSet<Event extends keyof SdkEventMap>(event: Event): Set<Listener<Event>> {\n    if (!this.listeners.has(event)) {\n      this.listeners.set(event, new Set());\n    }\n    return this.listeners.get(event)! as Set<Listener<Event>>;\n  }\n\n  on<Event extends keyof SdkEventMap>(event: Event, listener: Listener<Event>): void {\n    this.ensureListenerSet(event).add(listener);\n  }\n\n  off<Event extends keyof SdkEventMap>(event: Event, listener: Listener<Event>): void {\n    const listeners = this.listeners.get(event) as Set<Listener<Event>> | undefined;\n    listeners?.delete(listener);\n  }\n\n  emit<Event extends keyof SdkEventMap>(event: Event, payload: SdkEventMap[Event]): void {\n    const listeners = this.listeners.get(event) as Set<Listener<Event>> | undefined;\n    listeners?.forEach((listener) => listener(payload));\n  }\n}\n\nfunction resolveTokens(theme: Record<string, string> = {}): TokenMap {\n  return { ...baseTokens, ...theme } satisfies TokenMap;\n}\n\nfunction applyShadowStyles(root: ShadowRoot, theme: Record<string, string> = {}): void {\n  const style = document.createElement('style');\n  const tokens = resolveTokens(theme);\n  style.textContent = createShadowThemeCss(tokens);\n  root.appendChild(style);\n}\n\nfunction assertNoIframe(container: HTMLElement): void {\n  if (container.tagName.toLowerCase() === 'iframe' || container.querySelector('iframe')) {\n    throw new Error('Iframe containers are not supported. Embed must run in the host DOM.');\n  }\n}\n\nfunction renderPlan(root: ShadowRoot, plan: PageDoc, emitter: EventEmitter) {\n  const existing = root.querySelector('[data-root]');\n  if (existing) {\n    root.removeChild(existing);\n  }\n  const wrapper = document.createElement('div');\n  wrapper.setAttribute('data-root', '');\n  wrapper.setAttribute('role', 'region');\n  wrapper.setAttribute('aria-label', plan.title);\n\n  for (const block of plan.blocks) {\n    const section = document.createElement('section');\n    section.dataset.block = block.kind;\n    section.tabIndex = 0;\n    const heading = document.createElement('h2');\n    heading.textContent = block.kind.replace(/-/g, ' ');\n    section.appendChild(heading);\n\n    switch (block.kind) {\n      case 'collection-rail': {\n        const list = document.createElement('ul');\n        for (const event of block.data.events) {\n          const item = document.createElement('li');\n          item.textContent = `${event.name} — ${event.venue.name}`;\n          list.appendChild(item);\n        }\n        section.appendChild(list);\n        break;\n      }\n      case 'hero-carousel': {\n        const list = document.createElement('ul');\n        for (const item of block.data.items) {\n          const li = document.createElement('li');\n          li.textContent = item.headline;\n          list.appendChild(li);\n        }\n        section.appendChild(list);\n        break;\n      }\n      case 'filter-bar': {\n        const container = document.createElement('div');\n        const button = document.createElement('button');\n        button.type = 'button';\n        button.textContent = 'Reset filters';\n        button.addEventListener('click', () => {\n          emitter.emit('analytics:event', { name: 'filters.reset', payload: { active: block.data.active } });\n        });\n        container.appendChild(button);\n        section.appendChild(container);\n        break;\n      }\n      case 'map-grid': {\n        const map = document.createElement('div');\n        map.textContent = `Map with ${block.data.events.length} pins.`;\n        section.appendChild(map);\n        break;\n      }\n      case 'promo-slot': {\n        const disclosure = document.createElement('p');\n        disclosure.textContent = `${block.data.disclosure} • ${block.data.advertiser ?? 'House'}`;\n        section.appendChild(disclosure);\n        break;\n      }\n      case 'event-detail': {\n        const details = document.createElement('p');\n        details.textContent = block.data.event.description ?? block.data.event.name;\n        section.appendChild(details);\n        break;\n      }\n      case 'event-mini-chat': {\n        const chat = document.createElement('button');\n        chat.type = 'button';\n        chat.textContent = 'Ask about this event';\n        chat.addEventListener('click', () => {\n          emitter.emit('analytics:event', { name: 'chat.open', payload: { eventId: block.data.eventId } });\n        });\n        section.appendChild(chat);\n        break;\n      }\n      default: {\n        const pre = document.createElement('pre');\n        pre.textContent = JSON.stringify(block.data, null, 2);\n        section.appendChild(pre);\n        break;\n      }\n    }\n\n    wrapper.appendChild(section);\n  }\n\n  root.appendChild(wrapper);\n}\n\nexport function create({ container, tenantId, initialPlan, theme }: EmbedConfig): EmbedHandle {\n  assertNoIframe(container);\n  const shadow = container.attachShadow({ mode: 'open' });\n  applyShadowStyles(shadow, theme);\n  const emitter = new EventEmitter();\n\n  const handle: EmbedHandle = {\n    hydrateNext({ plan, pushState = true }) {\n      try {\n        renderPlan(shadow, plan, emitter);\n        if (pushState && typeof history !== 'undefined') {\n          const encoded = encodePlan(plan);\n          const url = new URL(window.location.href);\n          url.searchParams.set('plan', encoded);\n          history.replaceState({ plan: encoded }, '', url.toString());\n        }\n        emitter.emit('plan:hydrate', { plan });\n      } catch (error) {\n        emitter.emit('plan:error', { error: error as Error });\n      }\n    },\n    destroy() {\n      container.replaceChildren();\n    },\n    on(event, listener) {\n      emitter.on(event, listener);\n    },\n    off(event, listener) {\n      emitter.off(event, listener);\n    },\n    getShadowRoot() {\n      return shadow;\n    }\n  };\n\n  queueMicrotask(() => {\n    emitter.emit('ready', { tenantId });\n    if (initialPlan) {\n      handle.hydrateNext({ plan: initialPlan, pushState: false });\n    }\n  });\n\n  return handle;\n}\n\nexport { baseTokens } from './theme';\n","export type TokenMap = Record<string, string>;\n\nexport const baseTokens: TokenMap = {\n  '--eh-color-bg': '#0b1120',\n  '--eh-color-text': '#f8fafc',\n  \"--eh-font-family\": \"'Inter', system-ui, sans-serif\"\n};\n\nexport function toCustomPropertyDeclarations(tokens: TokenMap): string {\n  return Object.entries(tokens)\n    .map(([key, value]) => `${key}: ${value};`)\n    .join(' ');\n}\n\nexport function createShadowThemeCss(tokens: TokenMap): string {\n  const declarations = toCustomPropertyDeclarations(tokens);\n  return [\n    `:host{${declarations}}`,\n    '*, *::before, *::after { box-sizing: border-box; font-family: var(--eh-font-family); }',\n    'section[data-block]{ margin: 1rem 0; padding: 1rem; border-radius: 0.75rem; background: rgba(15,23,42,0.6); color: var(--eh-color-text); }',\n    'h2{ font-size: 1.25rem; margin: 0 0 0.5rem; }',\n    'ul{ margin: 0; padding-left: 1.25rem; }',\n    'button{ border-radius: 999px; border: 1px solid rgba(148,163,184,0.3); background: transparent; color: inherit; padding: 0.5rem 1rem; cursor: pointer; }',\n    'button:focus{ outline: 2px solid #38bdf8; outline-offset: 2px; }'\n  ].join('\\n');\n}\n\nexport function createRootTokenCss(tokens: TokenMap = baseTokens): string {\n  const declarations = toCustomPropertyDeclarations(tokens);\n  return `:root { ${declarations} }\\n`;\n}\n"],"mappings":"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","names":[]}
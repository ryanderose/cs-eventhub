---
title: "Events Hub Embed Implementation Survey"
date: "2025-11-09 16:43 EST"
researcher: "ChatGPT Codex 5"
question: "How does the cs-eventhub repository implement the canonical no-iframe embed defined in Final Spec v1.6, including SDK, admin, API, CDN, and host interactions?"
scope: "docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md plus supporting architecture/ADR/ops docs, apps/api, apps/admin, apps/demo-host (UI, API routes, SEO fragments), apps/cdn manifest, and packages (embed-sdk, router-helpers, page-schema, default-plan, ai-*, data-providers, telemetry, security)."
assumptions: ["Analysis limited to /Users/ryanderose/code/cs-eventhub.", "Spec Final 1.6 governs requirements; iframe/AMP fallbacks remain out of scope per stated non-goals."]
repository: "/Users/ryanderose/code/cs-eventhub"
branch: "develop"
commit_sha: "a274fa9"
status: "complete"
last_updated: "2025-11-09"
last_updated_by: "ChatGPT Codex 5"
directories_examined: ["docs/","apps/api/","apps/admin/","apps/demo-host/","packages/embed-sdk/","packages/page-schema/","packages/router-helpers/","packages/ai-composer/","packages/data-providers/","apps/cdn/"]
tags: ["research","codebase","embed-sdk","api","admin","demo-host","cdn"]
---

# Research: Events Hub Embed Implementation Survey

**Planning Hand-off (TL;DR)**  
- Shadow-DOM embed runtime mounts directly into the host DOM, renders simplified block sections, encodes PageDocs into History state, and emits analytics hooks, but it does not yet expose the spec-mandated `HubEmbed.consent` API or Trusted Types policy defined in §§7/9.3 (`packages/embed-sdk/src/index.ts:1-214`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/index.ts#L1-L214; `docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:200-338`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L200-L338).  
- Default plan orchestration stays deterministic via seeded templates, block allowlists, optimistic concurrency, and demo-host plan modes so admin drag-and-drop orderings propagate consistently across API + CDN surfaces (`packages/default-plan/src/index.ts:1-371`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/default-plan/src/index.ts#L1-L371; `apps/api/src/http/plan-default.ts:1-291`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/plan-default.ts#L1-L291; `apps/admin/app/blocks/BlocksClient.tsx:1-354`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/admin/app/blocks/BlocksClient.tsx#L1-L354; `apps/demo-host/lib/useDefaultPlan.ts:1-253`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/lib/useDefaultPlan.ts#L1-L253).  
- API/composer layers bridge the interpreter DSL, CitySpark provider caching, plan short-IDs, config signing, SEO fragments, and CDN manifests to satisfy Final Spec routing/SEO/telemetry guarantees (`apps/api/src/http/compose.ts:1-221`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/compose.ts#L1-L221; `packages/ai-composer/src/index.ts:1-421`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/ai-composer/src/index.ts#L1-L421; `packages/data-providers/src/index.ts:1-220`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/data-providers/src/index.ts#L1-L220; `apps/api/src/http/config-tenants.ts:1-119`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/config-tenants.ts#L1-L119; `apps/demo-host/app/(seo)/fragment/[tenant]/route.ts:1-74`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/(seo)/fragment/%5Btenant%5D/route.ts#L1-L74; `apps/cdn/public/hub-embed@latest/manifest.json:1-20`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/cdn/public/hub-embed@latest/manifest.json#L1-L20; `docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:220-305`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L220-L305).

## Research Question (from spec)
Describe how the current workspace realizes the canonical no-iframe embed (attributes, routing, consent, telemetry, acceptance gates) defined in Final Spec v1.6 and map the supporting admin, API, CDN, and host components that keep the snippet compliant with the routing/SEO/observability constraints (`docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:1-338`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L1-L338).

## System Overview (what exists today)
Events Hub is a pnpm/Turborepo workspace where Next.js apps (admin, demo-host, API BFF) consume shared packages for embed runtime, block schemas, AI interpreter/composer, router helpers, telemetry, security, and CDN publishing; the architecture snapshot codifies “apps produce experiences, packages provide reusable building blocks” plus strict instrumentation/security budgets tied to spec v1.6 guardrails (`docs/engineering/ARCHITECTURE.md:1-116`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/ARCHITECTURE.md#L1-L116).

## Detailed Findings

### Docs & Decisions
- README outlines the pre-seed scaffold, pnpm/Turborepo commands, and CI gates (typecheck, unit, lint, a11y, bundle, SBOM, CodeQL) that protect embed guardrails (`README.md:1-48`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/README.md#L1-L48).  
- Architecture doc details the monorepo topology (apps vs. packages), embed/server/admin flows, and observability/security/testing expectations backing the shadow-DOM runtime and AI surfaces (`docs/engineering/ARCHITECTURE.md:1-116`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/ARCHITECTURE.md#L1-L116).  
- Embed development guide documents local hostnames, linked vs. external embed modes, default plan hydration, manifest publishing, and beta/prod manifest toggles to keep dev/test flows parity-aware (`docs/engineering/embed-dev.md:1-193`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/embed-dev.md#L1-L193).  
- Final Spec v1.6 codifies declarative attributes, routing/history modes, consent buffering, telemetry schema, CDN/SRI mandates, and Trusted Types requirements for the no-iframe snippet (`docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:200-338`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L200-L338).  
- ADRs & ops docs freeze key decisions (no iframes, Preact runtime, strict fragment CSP) and operational budgets (OTel spans, SLO targets, privacy/threat mitigations) that every surface must honor (`docs/engineering/DECISIONS/ADR-0001-no-iframes.md:1-3`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/DECISIONS/ADR-0001-no-iframes.md#L1-L3; `docs/engineering/DECISIONS/ADR-0002-preact-embed.md:1-3`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/DECISIONS/ADR-0002-preact-embed.md#L1-L3; `docs/engineering/DECISIONS/ADR-0003-strict-csp-fragments.md:1-3`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/DECISIONS/ADR-0003-strict-csp-fragments.md#L1-L3; `docs/ops/OBSERVABILITY.md:1-2`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/ops/OBSERVABILITY.md#L1-L2; `docs/ops/SLOs.md:1-4`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/ops/SLOs.md#L1-L4; `docs/security/PRIVACY.md:1-4`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/security/PRIVACY.md#L1-L4; `docs/security/THREAT_MODEL.md:1-4`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/security/THREAT_MODEL.md#L1-L4).

### Domain & Data
- `PageDocSchema` enumerates all GA block kinds, analytics/a11y metadata, plan cursors, canonicalization, and SHA256 plan hashing so shared services can persist deterministic render plans (`packages/page-schema/src/index.ts:1-369`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/page-schema/src/index.ts#L1-L369).  
- `@events-hub/default-plan` seeds a stable block allowlist with consistent IDs/order, resolves demo events, and exposes helper labels/summaries that admin uses for drag-and-drop previews (`packages/default-plan/src/index.ts:1-434`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/default-plan/src/index.ts#L1-L434).  
- Router helpers compress PageDocs via zstd/brotli/plain encodings, base64-url them, and decode URL params so embed + API share the same query/hash persistence strategy (`packages/router-helpers/src/index.ts:1-149`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/router-helpers/src/index.ts#L1-L149).  
- The default plan store chooses Vercel KV when available, falls back to in-memory pointers, persists canonicalized/encoded plans, and keeps pointer caches for quick lookup (`apps/api/src/lib/pages-store.ts:1-117`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/lib/pages-store.ts#L1-L117; `apps/api/src/lib/plan.ts:1-114`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/lib/plan.ts#L1-L114).  
- AI interpreter/composer modules convert chat-like queries to filter DSL, enforce diversity quotas, and emit fully populated PageDocs (blocks, cursors, SEO fragments) before plan hashing (`packages/ai-interpreter/src/index.ts:1-224`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/ai-interpreter/src/index.ts#L1-L224; `packages/ai-composer/src/index.ts:1-421`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/ai-composer/src/index.ts#L1-L421).

### Entry Points & Routing
- The Express server disables `x-powered-by`, wires telemetry, and mounts REST endpoints for default plans, plan-by-id, compose, interpret, tenant configs, and fragment proxying so Node + Edge handlers reuse the same logic (`apps/api/src/app.ts:1-109`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/app.ts#L1-L109).  
- Demo host’s client page bootstraps the embed (linked vs. external), records data attributes about plan source/origin/hash, and hydrates via `useDefaultPlan` with retries/backoff before calling `hydrateNext` on plan changes (`apps/demo-host/app/page.tsx:1-305`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/page.tsx#L1-L305; `apps/demo-host/lib/useDefaultPlan.ts:1-253`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/lib/useDefaultPlan.ts#L1-L253).  
- Next.js routes proxy `/api/default-plan` to the API (respecting bypass tokens) and wrap `/app/(seo)/fragment/[tenant]` to hash upstream critical CSS while enforcing cache headers, ensuring hosts can serve SEO fragments without breaking CSP (`apps/demo-host/app/api/default-plan/route.ts:1-133`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/api/default-plan/route.ts#L1-L133; `apps/demo-host/app/(seo)/fragment/[tenant]/route.ts:1-74`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/(seo)/fragment/%5Btenant%5D/route.ts#L1-L74).  
- Edge fragment handler returns HTML or JSON (depending on `Accept`) with strict CSP and cache headers so the API can satisfy the spec’s Light-DOM parity requirements (`apps/api/api/v1/fragment.ts:1-74`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/api/v1/fragment.ts#L1-L74).

### Core Logic
- Embed SDK enforces “no iframe” containers, creates a ShadowRoot + theme style element, renders each block kind as a simple DOM section, rewrites the URL with `encodePlan`, and exposes a minimal event emitter for analytics, even though block-runtime/registry packages exist for richer Preact hydration (`packages/embed-sdk/src/index.ts:1-214`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/index.ts#L1-L214; `packages/embed-sdk/src/theme.ts:1-30`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/theme.ts#L1-L30; `packages/block-runtime/src/index.tsx:1-20`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/block-runtime/src/index.tsx#L1-L20; `packages/block-registry/src/index.ts:1-16`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/block-registry/src/index.ts#L1-L16).  
- Admin’s `BlocksClient` turns the PageDoc into sortable rows, supports keyboard/drag reordering, resets, optimistic saves, analytics emission, and conflict recovery (refresh after 412) via the plan client’s fetch/save helpers (`apps/admin/app/blocks/BlocksClient.tsx:1-354`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/admin/app/blocks/BlocksClient.tsx#L1-L354; `apps/admin/lib/plan-client.ts:1-174`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/admin/lib/plan-client.ts#L1-L174; `apps/admin/app/blocks/page.tsx:1-40`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/admin/app/blocks/page.tsx#L1-L40).  
- Default plan handler seeds from the template when absent, enforces block counts/order allowlists, applies optimistic concurrency using KV pointers, rewrites orders only (baseline data remains canonical), and encodes the updated plan for clients (`apps/api/src/http/plan-default.ts:1-291`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/plan-default.ts#L1-L291).  
- Compose handler normalizes payloads (tenant, filters, locale, streaming flags), reuses cached responses when planHash/composerVersion match, encodes canonical plans, persists short IDs when payloads exceed inline limits, and sets cache headers to honor revalidation windows (`apps/api/src/http/compose.ts:1-221`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/compose.ts#L1-L221).  
- Interpreter handler parses freeform queries into the DSL so composer + provider adapters receive normalized filters, while plan-by-id endpoint, plan seed script, and config handler supply the supporting infrastructure for pointer rewrites, CLI seeding, and tenant manifests (`apps/api/src/http/interpret.ts:1-19`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/interpret.ts#L1-L19; `apps/api/src/http/plan-by-id.ts:1-30`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/plan-by-id.ts#L1-L30; `apps/api/scripts/seed-default-plan.ts:1-148`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/scripts/seed-default-plan.ts#L1-L148; `apps/api/src/http/config-tenants.ts:1-119`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/config-tenants.ts#L1-L119).

### Integrations
- CitySpark adapter enforces quotas, tracks cache entries with TTL/stale-revalidate windows, feeds telemetry events (cache hit/miss, breaker states), simulates latency, and supports per-tenant search/bySlug resolution with canonical event IDs (`packages/data-providers/src/index.ts:1-220`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/data-providers/src/index.ts#L1-L220).  
- Telemetry package defines the `SdkEvent` union plus envelope, while the API telemetry config chooses noop/dev/prod emitters, validates env mode, and requires fetch+endpoint in prod (`packages/telemetry/src/index.ts:1-33`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/telemetry/src/index.ts#L1-L33; `apps/api/src/config/telemetry.ts:1-112`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/config/telemetry.ts#L1-L112; `apps/api/src/lib/telemetry.ts:1-23`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/lib/telemetry.ts#L1-L23).  
- Security helpers sanitize HTML and compose CSP strings; fragment responses and SEO proxy route apply those CSPs plus hashed CSS headers to align with ADR-0003’s “no unsafe-inline” guidance (`packages/security/src/index.ts:1-43`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/security/src/index.ts#L1-L43; `apps/api/src/lib/csp.ts:1-8`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/lib/csp.ts#L1-L8; `apps/demo-host/app/(seo)/fragment/[tenant]/route.ts:1-74`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/(seo)/fragment/%5Btenant%5D/route.ts#L1-L74).  
- CDN manifest tracks versioned assets (UMD, ESM, tokens) with SHA384 SRI, enabling spec-compliant script tags and admin snippet validation (`apps/cdn/public/hub-embed@latest/manifest.json:1-20`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/cdn/public/hub-embed@latest/manifest.json#L1-L20).

### Configuration & Secrets
- Plan client derives API bases from env/host headers, honors Vercel bypass tokens, and exposes server/client fetch helpers used by admin and demo-host surfaces (`apps/admin/lib/plan-client.ts:1-174`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/admin/lib/plan-client.ts#L1-L174).  
- Demo host env helpers detect local vs. remote hosts, derive config/API URLs (swapping `demo-host` → `api`/`config`), and expose embed/plan mode toggles, while the plan API proxy injects bypass tokens and supports tenant overrides via query params (`apps/demo-host/lib/env.ts:1-151`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/lib/env.ts#L1-L151; `apps/demo-host/app/api/default-plan/route.ts:1-133`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/api/default-plan/route.ts#L1-L133).  
- Tenant config builder reads CDN/API/env overrides for beta/prod manifests and embed src URLs, signs the payload when `CONFIG_SIGNING_SECRET` exists, and sets wide CORS/Timing headers for host fetches (`apps/api/src/config/tenants.ts:1-48`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/config/tenants.ts#L1-L48; `apps/api/src/http/config-tenants.ts:1-119`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/config-tenants.ts#L1-L119).  
- Telemetry mode and default plan seed script rely on env vars for mode selection, fetch bindings, KV credentials, and CLI options, ensuring prod emits network calls only when endpoints/tokens are configured (`apps/api/src/config/telemetry.ts:1-112`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/config/telemetry.ts#L1-L112; `apps/api/scripts/seed-default-plan.ts:1-148`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/scripts/seed-default-plan.ts#L1-L148).

### Tests & Observability
- Vitest suites cover default plan seeding/conflicts, API edge handlers (compose, fragment, plan resolver, interpreter), config signing, telemetry modes, demo-host embed hydration, SEO fragment hashing, and default-plan/theme helpers (`apps/api/__tests__/default-plan.test.ts:1-184`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/__tests__/default-plan.test.ts#L1-L184; `apps/api/__tests__/api.test.ts:1-138`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/__tests__/api.test.ts#L1-L138; `apps/api/__tests__/config.test.ts:1-81`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/__tests__/config.test.ts#L1-L81; `apps/api/__tests__/telemetry-mode.test.ts:1-149`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/__tests__/telemetry-mode.test.ts#L1-L149; `apps/demo-host/__tests__/page.test.tsx:1-200`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/__tests__/page.test.tsx#L1-L200; `apps/demo-host/__tests__/fragment-route.test.ts:1-73`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/__tests__/fragment-route.test.ts#L1-L73; `packages/default-plan/__tests__/default-plan.test.ts:1-58`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/default-plan/__tests__/default-plan.test.ts#L1-L58; `packages/embed-sdk/src/__tests__/theme.test.ts:1-21`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/__tests__/theme.test.ts#L1-L21).  
- Observability guardrails require spans for SDK/provider/composer/cache flows, latency histograms, and ClickHouse dashboards; `startSpan` helper wraps API operations while telemetry client logs/POSTs events depending on mode (`docs/ops/OBSERVABILITY.md:1-2`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/ops/OBSERVABILITY.md#L1-L2; `apps/api/src/lib/telemetry.ts:1-23`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/lib/telemetry.ts#L1-L23).

### API/UI Surface (as applicable)
- HTTP surface: `/v1/plan/default` (GET/PUT), `/v1/plan/:id`, `/v1/compose`, `/v1/interpret`, `/api/config/tenants/:tenant`, and `/v1/fragment` share handlers between Express + Vercel adapters, with telemetry + cache headers baked in (`apps/api/src/http/*.ts`, https://github.com/ryanderose/cs-eventhub/tree/a274fa9/apps/api/src/http).  
- Admin UI exposes the Default Blocks page with live status banners; demo host renders an embed container instrumented with plan metadata, config/API URLs, and status message, demonstrating the linked vs. external script workflow (`apps/admin/app/blocks/page.tsx:1-40`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/admin/app/blocks/page.tsx#L1-L40; `apps/demo-host/app/page.tsx:1-305`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/page.tsx#L1-L305).  
- CDN manifest enumerates bundle paths + SRI so host snippets (and the admin generator) can pin versions or use the `@latest` alias defined in the spec’s manifest section (`apps/cdn/public/hub-embed@latest/manifest.json:1-20`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/cdn/public/hub-embed@latest/manifest.json#L1-L20; `docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:239-268`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L239-L268).

## Evidence Log
- `README.md:1-48` — Repository scaffold, pnpm/Turbo commands, CI gates (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/README.md#L1-L48)  
- `docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:200-338` — Canonical snippet attributes, routing, consent, Trusted Types (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L200-L338)  
- `packages/embed-sdk/src/index.ts:1-214` — Shadow-DOM runtime, analytics emitter, URL rewriting (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/index.ts#L1-L214)  
- `apps/api/src/http/plan-default.ts:1-291` — Default plan fetch/update, seeding, validations (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/plan-default.ts#L1-L291)  
- `apps/admin/app/blocks/BlocksClient.tsx:1-354` — Tenant UI for drag-and-drop ordering (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/admin/app/blocks/BlocksClient.tsx#L1-L354)  
- `apps/demo-host/app/page.tsx:1-305` — Demo embed host bootstrap + status instrumentation (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/page.tsx#L1-L305)

## Code References (Index)
- `docs/engineering/embed-dev.md:1-193` — Local stack, plan modes, manifest publishing (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/embed-dev.md#L1-L193)  
- `packages/page-schema/src/index.ts:1-369` — Block schemas, plan hashing helpers (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/page-schema/src/index.ts#L1-L369)  
- `packages/default-plan/src/index.ts:1-434` — Default plan templates, allowlists, labels (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/default-plan/src/index.ts#L1-L434)  
- `packages/router-helpers/src/index.ts:1-149` — Plan encode/decode, compression selection (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/router-helpers/src/index.ts#L1-L149)  
- `apps/api/src/lib/pages-store.ts:1-117` — Pointer storage across KV/memory (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/lib/pages-store.ts#L1-L117)  
- `apps/api/src/http/compose.ts:1-221` — Composer cache, inline vs. short-id logic (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/http/compose.ts#L1-L221)  
- `packages/data-providers/src/index.ts:1-220` — CitySpark client quotas, caching, telemetry hooks (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/data-providers/src/index.ts#L1-L220)  
- `apps/demo-host/app/(seo)/fragment/[tenant]/route.ts:1-74` — SEO fragment proxy with CSS hashing (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/app/(seo)/fragment/%5Btenant%5D/route.ts#L1-L74)  
- `apps/api/__tests__/default-plan.test.ts:1-184` — Validation of seeding, concurrency, tuple checks (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/__tests__/default-plan.test.ts#L1-L184)  
- `apps/demo-host/__tests__/page.test.tsx:1-200` — Embed host hydration + plan metadata assertions (https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/demo-host/__tests__/page.test.tsx#L1-L200)

## Architecture & Patterns (as implemented)
The repo keeps a layered boundary: docs codify guardrails, packages encapsulate shared primitives (PageDoc schema, router helpers, AI interpreter/composer, telemetry, security), and apps act as ingress/experience layers. The embed SDK currently renders simple DOM but relies on shared PageDocs and router helpers; admin manipulates deterministic plans; the API BFF acts as composer/config/plan hub with telemetry spans; demo host + CDN manifest publish the snippet per spec. This mirrors the “apps produce experiences, packages provide reusable building blocks” architecture statement (`docs/engineering/ARCHITECTURE.md:8-70`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/ARCHITECTURE.md#L8-L70; `packages/embed-sdk/src/index.ts:1-214`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/index.ts#L1-L214; `apps/api/src/app.ts:1-109`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/apps/api/src/app.ts#L1-L109).

## Related Documentation
- Final embed spec v1.6 shared requirements (`docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:1-338`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L1-L338).  
- Architecture + embed dev guides for topology and local workflows (`docs/engineering/ARCHITECTURE.md:1-116`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/ARCHITECTURE.md#L1-L116; `docs/engineering/embed-dev.md:1-193`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/engineering/embed-dev.md#L1-L193).  
- ADRs for no-iframes, Preact runtime, and strict fragment CSP (`docs/engineering/DECISIONS/*.md`, https://github.com/ryanderose/cs-eventhub/tree/a274fa9/docs/engineering/DECISIONS).  
- Observability/SLO/privacy/threat notes for telemetry, latency budgets, and CMP expectations (`docs/ops/OBSERVABILITY.md:1-2`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/ops/OBSERVABILITY.md#L1-L2; `docs/ops/SLOs.md:1-4`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/ops/SLOs.md#L1-L4; `docs/security/PRIVACY.md:1-4`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/security/PRIVACY.md#L1-L4; `docs/security/THREAT_MODEL.md:1-4`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/security/THREAT_MODEL.md#L1-L4).

## Open Questions
- Spec §7 requires `HubEmbed.consent` with bounded buffering/flush + adapter visibility, but the current SDK exposes only a generic event emitter—no consent API or queueing is implemented yet. Need clarification on whether consent lives in another package or is pending in `packages/embed-sdk` (`docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:271-305`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L271-L305; `packages/embed-sdk/src/index.ts:1-214`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/index.ts#L1-L214).  
- Spec §9.3 mandates Trusted Types policies for HTML/script URLs, yet the embed runtime never registers a Trusted Types policy or falls back when `trustedTypes` is enforced—confirm whether another runtime component supplies this or if it remains a gap (`docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md:327-338`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/docs/specs/2025-11-09-events-hub-embed-final-spec-1.6.md#L327-L338; `packages/embed-sdk/src/index.ts:1-214`, https://github.com/ryanderose/cs-eventhub/blob/a274fa9/packages/embed-sdk/src/index.ts#L1-L214).

## Follow-up (append only, as needed)
- [2025-11-09 16:23] Initial embed/admin/API/CDN research baseline captured for Final Spec v1.6 alignment.  
- [2025-11-09 16:43] Expanded coverage with detailed package/app interactions, evidence log, config/env flows, tests, and explicit gaps around consent/Trusted Types.
